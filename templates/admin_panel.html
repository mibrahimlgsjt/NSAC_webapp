{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<div x-data="{ activeTab: 'medical', role: '{{ current_user.role }}' }" class="max-w-7xl mx-auto pb-20">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 glass p-6 rounded-[3rem] sticky top-24 z-30 shadow-sm border border-white/50">
        <h1 class="text-3xl font-black text-digital-lavender tracking-tight">Admin Dashboard</h1>
        
        <div class="flex space-x-1 bg-gray-100/50 p-1.5 rounded-full shadow-inner overflow-x-auto max-w-full">
            <button @click="activeTab = 'medical'" :class="activeTab === 'medical' ? 'bg-white text-digital-lavender shadow-md scale-105' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'" class="px-5 py-2.5 rounded-full font-bold transition transform text-sm whitespace-nowrap">Medical</button>
            <button @click="activeTab = 'feeding'" :class="activeTab === 'feeding' ? 'bg-white text-teal-600 shadow-md scale-105' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'" class="px-5 py-2.5 rounded-full font-bold transition transform text-sm whitespace-nowrap">Feeding</button>
            <button @click="activeTab = 'inventory'" :class="activeTab === 'inventory' ? 'bg-white text-yellow-600 shadow-md scale-105' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'" class="px-5 py-2.5 rounded-full font-bold transition transform text-sm whitespace-nowrap">Inventory</button>
            <button @click="activeTab = 'reports'" :class="activeTab === 'reports' ? 'bg-white text-red-500 shadow-md scale-105' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'" class="px-5 py-2.5 rounded-full font-bold transition transform text-sm whitespace-nowrap">Reports</button>
            <button @click="activeTab = 'management'" :class="activeTab === 'management' ? 'bg-white text-purple-600 shadow-md scale-105' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'" class="px-5 py-2.5 rounded-full font-bold transition transform text-sm whitespace-nowrap">Management</button>
        </div>
...
    <!-- Management Tab (Admin Only) -->
    <div x-show="activeTab === 'management'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" class="space-y-8">
        <div class="glass-strong p-8 rounded-[3rem] shadow-lg border-t-4 border-purple-400">
            <h2 class="text-2xl font-black text-gray-700 mb-6">Add New Animal</h2>
            <form action="/api/animal/add" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" name="name" placeholder="Name" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white" required>
                <select name="sector" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold text-gray-600 appearance-none shadow-sm hover:bg-white">
                    <option value="Concordia 1">Concordia 1</option>
                    <option value="Concordia 2">Concordia 2</option>
                    <option value="NBS">NBS</option>
                    <option value="SEECS">SEECS</option>
                    <option value="SADA">SADA</option>
                    <option value="SMME">SMME</option>
                    <option value="Retro Cafe">Retro Cafe</option>
                    <option value="Margalla Cafe">Margalla Cafe</option>
                    <option value="Sports Complex">Sports Complex</option>
                </select>
                <input type="text" name="image_url" placeholder="Image URL" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white">
                
                <button type="submit" class="md:col-span-3 bg-gradient-to-r from-digital-lavender to-purple-600 text-white font-black py-4 rounded-[2rem] shadow-lg hover:shadow-xl transition transform active:scale-95">
                    Add Animal to Database üêæ
                </button>
            </form>
        </div>

        <div class="glass p-8 rounded-[3rem]">
            <h2 class="text-2xl font-black text-gray-700 mb-6">Manage Animals</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for animal in animals %}
                <div class="bg-white/60 p-4 rounded-[2rem] border border-white/50 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-black text-gray-800">{{ animal.name }}</p>
                        <p class="text-xs font-bold text-gray-400">{{ animal.current_sector }}</p>
                    </div>
                    <form action="/api/animal/delete/{{ animal.id }}" method="POST">
                        <button type="submit" class="bg-red-50 text-red-500 hover:bg-red-500 hover:text-white p-3 rounded-full transition transform hover:scale-110 active:scale-90">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
        
        <a href="/logout" class="text-gray-400 hover:text-red-500 font-bold text-xs uppercase tracking-widest px-4">Logout</a>
    </div>

    <!-- Medical Log Tab -->
    <div x-show="activeTab === 'medical'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" class="space-y-8">
        <div class="glass-strong p-8 rounded-[3rem] shadow-lg border-t-4 border-white">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-700">New Case Entry</h2>
                {% if current_user.role == 'admin' %}
                <a href="/admin/export/logs" class="bg-gray-800 text-white text-xs font-bold uppercase tracking-widest px-4 py-2 rounded-full hover:bg-gray-700 transition transform hover:scale-105 shadow-lg">Export CSV</a>
                {% endif %}
            </div>
            
            <form action="/api/medical" method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative group">
                    <select name="animal_id" class="w-full p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold text-gray-700 appearance-none shadow-sm group-hover:bg-white">
                        {% for animal in animals %}
                        <option value="{{ animal.id }}">{{ animal.name }} ({{ animal.current_sector }})</option>
                        {% endfor %}
                    </select>
                    <div class="absolute right-4 top-4 pointer-events-none text-gray-400">‚ñº</div>
                </div>
                
                <input type="text" name="condition" placeholder="Condition (e.g. Flu)" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white" required>
                <input type="text" name="clinic_name" placeholder="Clinic Name" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white">
                <input type="number" step="0.01" name="cost" placeholder="Cost (PKR)" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white">
                <input type="text" name="rescuer_name" placeholder="Rescuer Name" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white">
                <input type="date" name="release_date" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold text-gray-500 shadow-sm hover:bg-white">
                
                <button type="submit" class="md:col-span-2 bg-gradient-to-r from-digital-lavender to-purple-600 text-white font-black py-4 rounded-[2rem] shadow-xl hover:shadow-2xl hover:scale-[1.02] transition transform active:scale-95">
                    Log Medical Case ü©∫
                </button>
            </form>
        </div>

        <div class="glass p-8 rounded-[3rem] overflow-hidden">
             <h2 class="text-2xl font-black text-gray-700 mb-6">Recent History</h2>
             <div class="overflow-x-auto">
                 <table class="w-full text-left border-collapse min-w-[600px]">
                     <thead>
                         <tr class="text-gray-400 text-xs font-bold uppercase tracking-widest border-b border-gray-200">
                             <th class="p-4 pl-6">Date</th>
                             <th class="p-4">Patient</th>
                             <th class="p-4">Condition</th>
                             <th class="p-4 pr-6">Status</th>
                         </tr>
                     </thead>
                     <tbody class="text-sm">
                         {% for log in medical_logs %}
                         <tr class="border-b border-gray-100 hover:bg-white/40 transition group">
                             <td class="p-4 pl-6 font-bold text-gray-500">{{ log.date.strftime('%d %b') }}</td>
                             <td class="p-4 font-black text-gray-800 text-lg group-hover:text-digital-lavender transition">{{ log.animal.name }}</td>
                             <td class="p-4 text-gray-600 font-medium">{{ log.condition }}</td>
                             <td class="p-4 pr-6">
                                 {% if log.release_date %}
                                 <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider">Released</span>
                                 {% else %}
                                 <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider animate-pulse">Active</span>
                                 {% endif %}
                             </td>
                         </tr>
                         {% endfor %}
                     </tbody>
                 </table>
             </div>
        </div>
    </div>

    <!-- Feeding Tracker Tab -->
    <div x-show="activeTab === 'feeding'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" class="space-y-8">
        <div class="glass-strong p-10 rounded-[3rem] text-center relative overflow-hidden">
             <div class="absolute inset-0 bg-neo-mint/10 blur-3xl rounded-full transform scale-150"></div>
             <h2 class="text-3xl font-black text-gray-700 mb-8 relative z-10">Quick Feed Update</h2>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-6 relative z-10">
                 {% for sector in ['C1', 'C2', 'NBS', 'SEECS'] %}
                 <button @click="fetch('/api/feed', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({sector: '{{ sector }}', volunteer_name: 'Admin'})
                 }).then(res => res.json()).then(data => {
                     confetti({
                         particleCount: 150,
                         spread: 100,
                         origin: { y: 0.6 },
                         colors: ['#A8E6CF', '#FF6F61', '#F4E99B']
                     });
                     setTimeout(() => location.reload(), 1500);
                 })" class="group relative bg-white border-4 border-neo-mint/30 hover:border-neo-mint text-teal-800 font-black py-10 rounded-[2.5rem] shadow-lg hover:shadow-xl transition transform hover:-translate-y-2 active:scale-95 text-2xl overflow-hidden">
                     <div class="absolute inset-0 bg-neo-mint opacity-0 group-hover:opacity-20 transition duration-500"></div>
                     {{ sector }}
                 </button>
                 {% endfor %}
             </div>
        </div>
        
        <div class="glass p-8 rounded-[3rem]">
             <h2 class="text-2xl font-black text-gray-700 mb-6">Recent Feeding Logs</h2>
             <ul class="space-y-4">
                 {% for log in feeding_logs %}
                 <li class="flex justify-between items-center text-gray-600 bg-white/40 p-4 rounded-[1.5rem] border border-white/50 shadow-sm hover:bg-white/70 transition">
                     <span class="font-medium"><strong class="text-digital-lavender">{{ log.volunteer_name }}</strong> fed {{ log.location_sector }}</span>
                     <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded-lg">{{ log.timestamp.strftime('%H:%M') }}</span>
                 </li>
                 {% endfor %}
             </ul>
        </div>
    </div>

    <!-- Inventory Tab -->
    <div x-show="activeTab === 'inventory'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" class="space-y-8">
        <!-- Low Stock Alerts -->
        {% if alerts %}
        <div class="bg-red-50 border-4 border-red-200 p-6 rounded-[2rem] shadow-lg animate-pulse">
            <h3 class="font-black text-red-500 text-lg mb-2 flex items-center"><span class="mr-2">‚ö†Ô∏è</span> Low Stock Alerts</h3>
            <ul class="space-y-1 pl-8 text-red-600 font-bold list-disc">
                {% for alert in alerts %}
                <li>{{ alert }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="glass-strong p-8 rounded-[3rem] shadow-lg border-t-4 border-yellow-200">
            <h2 class="text-2xl font-black text-gray-700 mb-6">Update Stock</h2>
            <form action="/api/inventory/update" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" name="name" placeholder="Item Name" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm col-span-2 hover:bg-white" required>
                <input type="number" step="0.1" name="quantity" placeholder="Qty" class="p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold placeholder-gray-400 shadow-sm hover:bg-white" required>
                <div class="relative">
                    <select name="category" class="w-full p-4 bg-white/60 rounded-[2rem] border-2 border-transparent focus:border-digital-lavender focus:ring-0 transition font-bold text-gray-600 appearance-none shadow-sm hover:bg-white">
                        <option value="A">Category A (High Value)</option>
                        <option value="B">Category B</option>
                        <option value="C">Category C (Consumables)</option>
                    </select>
                </div>
                <button type="submit" class="md:col-span-4 bg-gradient-to-r from-soft-butter to-yellow-400 text-yellow-900 font-black py-4 rounded-[2rem] shadow-lg hover:shadow-xl hover:scale-[1.01] transition transform active:scale-95 mt-2">
                    Update Stock üì¶
                </button>
            </form>
        </div>

        <div class="glass p-8 rounded-[3rem] overflow-hidden">
            <table class="w-full text-left border-collapse min-w-[600px]">
                <thead>
                    <tr class="text-gray-400 text-xs font-bold uppercase tracking-widest border-b border-gray-200">
                        <th class="p-4 pl-6">Item</th>
                        <th class="p-4">Category</th>
                        <th class="p-4">Qty</th>
                        <th class="p-4 pr-6">Status</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    {% for item in inventory_items %}
                    <tr class="border-b border-gray-100 hover:bg-white/40 transition group">
                        <td class="p-4 pl-6 font-black text-gray-800 text-lg group-hover:text-digital-lavender transition">{{ item.name }}</td>
                        <td class="p-4">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider {{ 'bg-red-100 text-red-600' if item.category == 'A' else 'bg-blue-50 text-blue-500' }}">
                                {{ item.category }}
                            </span>
                        </td>
                        <td class="p-4 font-bold text-gray-600">{{ item.quantity }} <span class="text-gray-400 text-xs">{{ item.unit }}</span></td>
                        <td class="p-4 pr-6">
                            {% if (item.category == 'A' and item.quantity < 5) or (item.category == 'C' and item.quantity < 20) %}
                            <span class="text-red-500 font-black text-xs bg-red-50 px-2 py-1 rounded-lg">Low Stock</span>
                            {% else %}
                            <span class="text-green-500 font-black text-xs bg-green-50 px-2 py-1 rounded-lg">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Reports Tab -->
    <div x-show="activeTab === 'reports'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" class="space-y-8">
        <div class="glass-strong p-8 rounded-[3rem] shadow-lg border-t-4 border-hyper-coral">
            <h2 class="text-2xl font-black text-gray-700 mb-6">Emergency Reports</h2>
            {% if not emergency_reports %}
            <div class="text-center py-10 opacity-50">
                <div class="text-4xl mb-2">‚úÖ</div>
                <p class="font-bold text-gray-500">All clear! No pending reports.</p>
            </div>
            {% else %}
            <div class="space-y-4">
                {% for report in emergency_reports %}
                <div class="bg-white/60 p-6 rounded-[2.5rem] border-l-8 {{ 'border-red-500 shadow-red-100' if report.status == 'Pending' else 'border-green-500 shadow-green-100' }} shadow-lg transition transform hover:scale-[1.01]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <span class="text-[10px] font-black uppercase tracking-widest {{ 'text-red-500' if report.status == 'Pending' else 'text-green-500' }} mb-1 block">{{ report.status }}</span>
                            <h3 class="text-xl font-black text-gray-800">{{ report.issue_type }}</h3>
                            <p class="text-sm font-bold text-gray-600 flex items-center mt-1"><span class="mr-1">üìç</span> {{ report.location }}</p>
                            <p class="text-sm text-gray-500 mt-2 italic">"{{ report.description }}"</p>
                            <p class="text-xs text-gray-400 mt-2 font-bold">{{ report.timestamp.strftime('%d %b %H:%M') }}</p>
                        </div>
                        {% if report.status == 'Pending' %}
                        <button @click="fetch('/api/resolve_report/{{ report.id }}', {method: 'POST'}).then(() => location.reload())" class="bg-green-500 text-white px-6 py-3 rounded-full text-xs font-black uppercase tracking-widest hover:bg-green-600 transition shadow-lg transform hover:scale-105 active:scale-95 whitespace-nowrap">
                            Mark Resolved ‚úì
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}
